<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coinly Ton | Elite Admin Nexus</title>
    
    <!-- Premium Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --bg: #020617;
            --primary: #00ff88;
            --secondary: #00aeff;
            --danger: #ff4757;
            --purple: #d946ef;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(0, 255, 136, 0.2);
            --neon-glow: 0 0 15px rgba(0, 255, 136, 0.4);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--bg);
            color: #e2e8f0;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 255, 136, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(0, 174, 255, 0.05) 0%, transparent 40%);
        }

        /* --- LOGIN SCREEN STYLES --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #020617; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            width: 100%; max-width: 400px;
            padding: 40px;
            background: rgba(2, 6, 23, 0.95);
            border: 1px solid var(--primary);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.2);
            border-radius: 20px;
            text-align: center;
        }
        .app-interface { display: none; } /* Hidden until logged in */

        /* Sidebar VFX */
        .sidebar {
            width: 280px;
            height: 100vh;
            background: rgba(2, 6, 23, 0.9);
            backdrop-filter: blur(20px);
            position: fixed;
            border-right: 1px solid var(--border);
            z-index: 1000;
            transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: var(--neon-glow);
        }

        .nav-link {
            color: #94a3b8;
            padding: 15px 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
            font-size: 1.1rem;
            border-left: 4px solid transparent;
            transition: 0.3s;
            cursor: pointer;
            text-decoration: none;
        }

        .nav-link:hover, .nav-link.active {
            background: var(--glass);
            color: var(--primary);
            border-left: 4px solid var(--primary);
            text-shadow: 0 0 10px var(--primary);
        }

        .main-content {
            margin-left: 280px;
            padding: 40px;
            transition: 0.5s;
        }

        /* Glass Cards */
        .glass-card {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
            transition: 0.3s ease;
            height: 100%;
        }

        .glass-card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.1);
            transform: translateY(-5px);
        }

        /* Stats VFX */
        .stat-val {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.2rem;
            font-weight: 700;
            margin: 10px 0;
        }

        /* Input Styles */
        input, select {
            background: rgba(0,0,0,0.5) !important;
            border: 1px solid var(--border) !important;
            color: #fff !important;
            border-radius: 12px !important;
            padding: 12px 20px !important;
        }

        .btn-neon {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 10px 25px;
            border-radius: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: 0.4s;
            position: relative;
            overflow: hidden;
        }

        .btn-neon:hover {
            background: var(--primary);
            color: #000;
            box-shadow: var(--neon-glow);
        }

        /* User Table Custom */
        .custom-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
        }

        .custom-table tr {
            background: rgba(255,255,255,0.02);
            transition: 0.3s;
        }

        .custom-table td, .custom-table th {
            padding: 15px;
            vertical-align: middle;
            color: #cbd5e1;
        }

        .custom-table tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }

        .avatar-circle {
            width: 45px; height: 45px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #000; font-weight: bold;
        }

        .section { display: none; }
        .active-section { 
            display: block; 
            animation: fadeInRight 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Mobile Adjustments */
        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); width: 250px; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 20px; }
            .mobile-btn { display: block !important; }
        }

        .mobile-btn {
            display: none; position: fixed; bottom: 20px; right: 20px;
            background: var(--primary); border: none; width: 60px; height: 60px;
            border-radius: 50%; z-index: 2000; box-shadow: var(--neon-glow);
        }

        @keyframes fadeInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="login-overlay">
    <div class="login-box animate__animated animate__zoomIn">
        <h2 class="text-primary mb-4" style="font-family: 'Orbitron'">SYSTEM LOCKED</h2>
        <div class="mb-3">
            <input type="email" id="adminEmail" class="form-control text-center" placeholder="Admin Email">
        </div>
        <div class="mb-4">
            <input type="password" id="adminPass" class="form-control text-center" placeholder="Access Code">
        </div>
        <button class="btn btn-neon w-100" onclick="handleLogin()">AUTHENTICATE</button>
        <p id="loginError" class="text-danger mt-3 small"></p>
    </div>
</div>

<!-- MAIN APP (Hidden initially) -->
<div class="app-interface">
    <button class="mobile-btn" onclick="document.getElementById('sidebar').classList.toggle('active')">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <h2>NEXUS ADMIN</h2>
        <a class="nav-link active" onclick="showSection('home', this)"><i class="fas fa-layer-group"></i> Overview</a>
        <a class="nav-link" onclick="showSection('users', this)"><i class="fas fa-users-viewfinder"></i> User Matrix</a>
        <a class="nav-link" onclick="showSection('withdraw', this)"><i class="fas fa-credit-card"></i> Pay-outs</a>
        <a class="nav-link" onclick="showSection('task', this)"><i class="fas fa-microchip"></i> Task Core</a>
        <!-- Video section removed -->
        <a class="nav-link text-danger mt-5" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Terminate Session</a>
    </div>

    <div class="main-content">
        
        <!-- HOME SECTION -->
        <div id="home" class="section active-section">
            <h2 class="mb-4">Live System Analytics</h2>
            <div class="row g-4">
                <div class="col-xl-3 col-md-6">
                    <div class="glass-card">
                        <p class="text-muted">Total Operatives</p>
                        <div class="stat-val" id="totalUsers">0</div>
                        <div class="progress" style="height: 5px; background: #1e293b;">
                            <div class="progress-bar bg-primary" style="width: 70%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="glass-card">
                        <p class="text-muted" style="color: var(--purple) !important;">Joined Today</p>
                        <div class="stat-val" id="todayJoined" style="color: var(--purple);">0</div>
                        <i class="fas fa-user-clock float-end mt-n4 opacity-50"></i>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="glass-card">
                        <p class="text-muted" style="color: var(--secondary) !important;">Total TON Assets</p>
                        <div class="stat-val" id="totalTon" style="color: var(--secondary);">0.00</div>
                        <i class="fas fa-chart-line float-end mt-n4 opacity-50"></i>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="glass-card">
                        <p class="text-muted" style="color: #f1c40f !important;">Total USDT Assets</p>
                        <div class="stat-val" id="totalUsdt" style="color: #f1c40f;">0.00</div>
                        <i class="fas fa-wallet float-end mt-n4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- USER MATRIX SECTION -->
        <div id="users" class="section">
            <h2 class="mb-4">User Matrix Control</h2>
            <div class="glass-card mb-4">
                <div class="row g-3">
                    <div class="col-md-8">
                        <input type="text" id="userSearch" class="form-control" placeholder="Identify User by UID or Username...">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-neon w-100" onclick="searchUser()"><i class="fas fa-radar"></i> Scan UID</button>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="table-responsive">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th>TON Bal</th>
                                <th>USDT Bal</th>
                                <th>Refers</th>
                                <th>Joined</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="userList"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- WITHDRAW SECTION -->
        <div id="withdraw" class="section">
            <h2 class="mb-4">Payout Processing</h2>
            <div class="glass-card">
                <div class="table-responsive">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Telegram User</th>
                                <th>Amount</th>
                                <th>Refers</th>
                                <th>Wallet Address</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawList"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TASK CORE SECTION (UPDATED) -->
        <div id="task" class="section">
            <h2 class="mb-4">Task Deployment & Management</h2>
            <div class="row g-4">
                <!-- Add Task Form -->
                <div class="col-md-5">
                    <div class="glass-card">
                        <h4 class="text-primary mb-3"><i class="fas fa-plus-circle"></i> Create New Task</h4>
                        <div class="mb-3">
                            <label class="text-muted">Task Title</label>
                            <input type="text" id="taskTitle" class="form-control" placeholder="e.g. Subscribe Channel">
                        </div>
                        <div class="mb-3">
                            <label class="text-muted">Target Link</label>
                            <input type="text" id="taskLink" class="form-control" placeholder="https://t.me/...">
                        </div>
                        <div class="mb-3">
                            <label class="text-muted">TON Reward</label>
                            <input type="number" id="taskReward" class="form-control" step="0.01">
                        </div>
                        <button class="btn btn-neon w-100" onclick="deployTask()">Deploy Task</button>
                    </div>
                </div>
                
                <!-- Manage Tasks List -->
                <div class="col-md-7">
                    <div class="glass-card">
                        <h4 class="text-secondary mb-3"><i class="fas fa-tasks"></i> Active Tasks</h4>
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="custom-table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Reward</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="activeTaskList">
                                    <!-- Tasks will load here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Firebase Logic -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, updateDoc, onSnapshot, query, where, addDoc, deleteDoc, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAUQBTiqBfPwM5idPo9GKwuggvyRFKSopE",
        authDomain: "coinly-tix-ton-fd0c3.firebaseapp.com",
        projectId: "coinly-tix-ton-fd0c3",
        storageBucket: "coinly-tix-ton-fd0c3.firebasestorage.app",
        messagingSenderId: "204024049838",
        appId: "1:204024049838:web:b64e08efe08526b0c33d3f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- AUTHENTICATION LOGIC ---
    const loginOverlay = document.getElementById('login-overlay');
    const appInterface = document.querySelector('.app-interface');

    onAuthStateChanged(auth, (user) => {
        if (user) {
            loginOverlay.style.display = 'none';
            appInterface.style.display = 'block';
            console.log("Admin Connected: " + user.email);
            startListeners(); 
        } else {
            loginOverlay.style.display = 'flex';
            appInterface.style.display = 'none';
        }
    });

    window.handleLogin = async () => {
        const email = document.getElementById('adminEmail').value;
        const pass = document.getElementById('adminPass').value;
        const errorMsg = document.getElementById('loginError');

        try {
            errorMsg.innerText = "Verifying Credentials...";
            await signInWithEmailAndPassword(auth, email, pass);
        } catch (error) {
            errorMsg.innerText = "Access Denied: " + error.message;
        }
    };

    window.handleLogout = () => {
        if(confirm("Terminate Admin Session?")) {
            signOut(auth);
        }
    };

    // --- APP LOGIC ---
    function startListeners() {
        
        // 1. Dashboard Logic (Includes Daily Joined Counter)
        onSnapshot(collection(db, "users"), (snap) => {
            let totalTon = 0, totalUsdt = 0;
            let todayCount = 0;
            const todayStr = new Date().toDateString(); // e.g., "Fri Jan 23 2026"

            snap.forEach(d => {
                const data = d.data();
                totalTon += (data.balance || 0);
                totalUsdt += (data.balanceUSDT || 0);
                
                // Logic to count daily joined users
                let joinDate = null;
                if (data.joinedAt) joinDate = data.joinedAt.toDate();
                else if (data.timestamp) joinDate = data.timestamp.toDate();
                
                if (joinDate && joinDate.toDateString() === todayStr) {
                    todayCount++;
                }
            });

            document.getElementById('totalUsers').innerText = snap.size;
            document.getElementById('totalTon').innerText = totalTon.toFixed(2);
            document.getElementById('totalUsdt').innerText = totalUsdt.toFixed(2);
            document.getElementById('todayJoined').innerText = todayCount;
        }, (error) => {
            console.error("Auth Error:", error);
        });

        // 2. Load Users
        loadUsers();

        // 3. Withdrawals
        onSnapshot(query(collection(db, "withdrawals"), where("status", "==", "pending")), (snap) => {
            const wList = document.getElementById('withdrawList');
            wList.innerHTML = "";
            snap.forEach(async (withdrawDoc) => {
                const w = withdrawDoc.data();
                const wId = withdrawDoc.id;
                const userRef = doc(db, "users", w.userId);
                const userSnap = await getDoc(userRef);
                const u = userSnap.exists() ? userSnap.data() : {};

                wList.innerHTML += `
                    <tr class="animate__animated animate__zoomIn">
                        <td>
                            <div class="fw-bold text-primary">@${u.username || 'unknown'}</div>
                            <small class="text-muted">UID: ${w.userId}</small>
                        </td>
                        <td><b class="text-white">${w.amount}</b> ${w.currency}</td>
                        <td><span class="text-warning"><i class="fas fa-users"></i> ${u.referrals || 0}</span></td>
                        <td>
                            <div class="d-flex gap-2">
                                <input type="text" value="${w.address}" class="form-control form-control-sm" readonly style="width:120px; font-size:10px;">
                                <button class="btn btn-sm btn-dark" onclick="copy('${w.address}')"><i class="fas fa-copy"></i></button>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-neon" onclick="completePayment('${wId}')">PAID</button>
                        </td>
                    </tr>`;
            });
        });

        // 4. Task Management List (NEW)
        onSnapshot(query(collection(db, "tasks"), orderBy("createdAt", "desc")), (snap) => {
            const taskList = document.getElementById('activeTaskList');
            taskList.innerHTML = "";
            if (snap.empty) {
                taskList.innerHTML = `<tr><td colspan="3" class="text-center text-muted">No active tasks found.</td></tr>`;
                return;
            }
            snap.forEach(d => {
                const task = d.data();
                const id = d.id;
                taskList.innerHTML += `
                    <tr>
                        <td>
                            <div class="fw-bold text-white">${task.title}</div>
                            <small class="text-muted" style="font-size: 0.75rem;">${task.link.substring(0, 20)}...</small>
                        </td>
                        <td class="text-primary">${task.reward} TON</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTask('${id}')" title="Delete Task">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        });
    }

    // --- ACTIONS ---
    function loadUsers() {
        onSnapshot(query(collection(db, "users"), limit(50)), (snap) => {
            const list = document.getElementById('userList');
            list.innerHTML = "";
            snap.forEach(docSnap => {
                const u = docSnap.data();
                const id = docSnap.id;
                let joinDateStr = u.joinedAt ? u.joinedAt.toDate().toLocaleDateString() : (u.timestamp ? u.timestamp.toDate().toLocaleDateString() : "N/A");
                
                list.innerHTML += `
                    <tr class="animate__animated animate__fadeInUp">
                        <td>
                            <div class="d-flex align-items-center gap-3">
                                <div class="avatar-circle">${u.firstName ? u.firstName.charAt(0) : '?'}</div>
                                <div>
                                    <div class="fw-bold text-white">${u.firstName || 'Unknown'}</div>
                                    <small class="text-muted">@${u.username || 'N/A'}</small>
                                </div>
                            </div>
                        </td>
                        <td class="text-info">${(u.balance || 0).toFixed(4)}</td>
                        <td class="text-warning">${(u.balanceUSDT || 0).toFixed(2)}</td>
                        <td><span class="badge bg-dark border border-primary text-primary">${u.referrals || 0}</span></td>
                        <td class="text-muted" style="font-size:0.8rem">${joinDateStr}</td>
                        <td><span class="badge ${u.isBanned ? 'bg-danger' : 'bg-success'}">${u.isBanned ? 'BANNED' : 'ACTIVE'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="toggleBan('${id}', ${u.isBanned})"><i class="fas fa-power-off"></i></button>
                        </td>
                    </tr>`;
            });
        });
    }

    window.searchUser = async () => {
        const key = document.getElementById('userSearch').value.trim();
        if(!key) return loadUsers();
        const list = document.getElementById('userList');
        list.innerHTML = "Scanning Matrix...";
        try {
            const docRef = doc(db, "users", key);
            const docSnap = await getDoc(docRef);
            if(docSnap.exists()){
                const u = docSnap.data();
                const id = docSnap.id;
                let joinDateStr = u.joinedAt ? u.joinedAt.toDate().toLocaleDateString() : "N/A";
                list.innerHTML = `
                <tr class="animate__animated animate__fadeInUp">
                    <td>
                        <div class="d-flex align-items-center gap-3">
                            <div class="avatar-circle">${u.firstName ? u.firstName.charAt(0) : '?'}</div>
                            <div>
                                <div class="fw-bold text-white">${u.firstName || 'Unknown'}</div>
                                <small class="text-muted">@${u.username || 'N/A'}</small>
                            </div>
                        </div>
                    </td>
                    <td class="text-info">${(u.balance || 0).toFixed(4)}</td>
                    <td class="text-warning">${(u.balanceUSDT || 0).toFixed(2)}</td>
                    <td><span class="badge bg-dark border border-primary text-primary">${u.referrals || 0}</span></td>
                    <td class="text-muted">${joinDateStr}</td>
                    <td><span class="badge ${u.isBanned ? 'bg-danger' : 'bg-success'}">${u.isBanned ? 'BANNED' : 'ACTIVE'}</span></td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="toggleBan('${id}', ${u.isBanned})"><i class="fas fa-power-off"></i></button></td>
                </tr>`;
            } else { alert("Operative not found!"); loadUsers(); }
        } catch(e) { console.error(e); alert("Search Error"); }
    };

    // --- DEPLOY TASK ---
    window.deployTask = async () => {
        if(!auth.currentUser) return alert("Session Expired. Login again.");
        
        const title = document.getElementById('taskTitle').value;
        const link = document.getElementById('taskLink').value;
        const reward = parseFloat(document.getElementById('taskReward').value);

        if(!title || !link || isNaN(reward)) return alert("Check inputs!");

        try {
            await addDoc(collection(db, "tasks"), { 
                title, link, reward, icon: "fab fa-telegram", category: "channel", createdAt: Timestamp.now()
            });
            // alert("Task Deployed!"); // Optional: remove alert to be less annoying as table updates auto
            document.getElementById('taskTitle').value = "";
            document.getElementById('taskLink').value = "";
            document.getElementById('taskReward').value = "";
        } catch (e) { console.error(e); alert("Permission Denied: Only Admins can add tasks."); }
    };

    // --- DELETE TASK (NEW) ---
    window.deleteTask = async (id) => {
        if(!auth.currentUser) return alert("Session Expired.");
        if(confirm("Are you sure you want to delete this task? Users will no longer see it.")) {
            try {
                await deleteDoc(doc(db, "tasks", id));
            } catch(e) {
                console.error(e);
                alert("Error deleting task.");
            }
        }
    };

    // --- HELPERS ---
    window.showSection = (id, btn) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active-section'));
        document.getElementById(id).classList.add('active-section');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        btn.classList.add('active');
    };
    window.toggleBan = async (uid, status) => {
        if(!auth.currentUser) return;
        await updateDoc(doc(db, "users", uid), { isBanned: !status });
    };
    window.completePayment = async (id) => {
        if(!auth.currentUser) return;
        if(confirm("Confirm this transaction as PAID?")) {
            await updateDoc(doc(db, "withdrawals", id), { status: "paid" });
        }
    };
    window.copy = (txt) => { navigator.clipboard.writeText(txt); alert("Copied!"); };

</script>

</body>
</html>