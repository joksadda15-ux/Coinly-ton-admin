<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coinly Admin Nexus | V2.0</title>
    
    <!-- Premium Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --bg: #020617;
            --primary: #00ff88;
            --secondary: #00aeff;
            --danger: #ff4757;
            --purple: #d946ef;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(0, 255, 136, 0.2);
            --neon-glow: 0 0 15px rgba(0, 255, 136, 0.4);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--bg);
            color: #e2e8f0;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 255, 136, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(0, 174, 255, 0.05) 0%, transparent 40%);
        }

        /* --- LOGIN SCREEN --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #020617; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            width: 100%; max-width: 400px; padding: 40px;
            background: rgba(2, 6, 23, 0.95);
            border: 1px solid var(--primary);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.2);
            border-radius: 20px; text-align: center;
        }
        .app-interface { display: none; }

        /* Sidebar VFX */
        .sidebar {
            width: 280px; height: 100vh;
            background: rgba(2, 6, 23, 0.9);
            backdrop-filter: blur(20px);
            position: fixed; border-right: 1px solid var(--border);
            z-index: 1000; transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sidebar h2 {
            font-family: 'Orbitron', sans-serif; font-size: 1.5rem;
            text-align: center; padding: 30px 0;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: var(--neon-glow);
        }
        .nav-link {
            color: #94a3b8; padding: 15px 30px;
            display: flex; align-items: center; gap: 15px;
            font-weight: 600; font-size: 1.1rem;
            border-left: 4px solid transparent; transition: 0.3s;
            cursor: pointer; text-decoration: none;
        }
        .nav-link:hover, .nav-link.active {
            background: var(--glass); color: var(--primary);
            border-left: 4px solid var(--primary);
            text-shadow: 0 0 10px var(--primary);
        }

        .main-content { margin-left: 280px; padding: 40px; transition: 0.5s; }

        /* Glass Cards */
        .glass-card {
            background: var(--glass); border: 1px solid var(--border);
            border-radius: 24px; padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
            transition: 0.3s ease; height: 100%;
        }
        .glass-card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.1);
            transform: translateY(-5px);
        }
        .stat-val { font-family: 'Orbitron', sans-serif; font-size: 2.2rem; font-weight: 700; margin: 10px 0; }

        /* Input Styles */
        input, select {
            background: rgba(0,0,0,0.5) !important;
            border: 1px solid var(--border) !important;
            color: #fff !important;
            border-radius: 12px !important; padding: 12px 20px !important;
        }
        input:focus, select:focus {
            box-shadow: 0 0 10px var(--primary) !important;
            border-color: var(--primary) !important;
        }

        .btn-neon {
            background: transparent; border: 1px solid var(--primary);
            color: var(--primary); padding: 10px 25px;
            border-radius: 12px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px;
            transition: 0.4s; position: relative; overflow: hidden;
        }
        .btn-neon:hover {
            background: var(--primary); color: #000;
            box-shadow: var(--neon-glow);
        }

        .custom-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .custom-table tr { background: rgba(255,255,255,0.02); transition: 0.3s; }
        .custom-table td, .custom-table th { padding: 15px; vertical-align: middle; color: #cbd5e1; }
        .custom-table tr:hover { background: rgba(0, 255, 136, 0.05); }

        .section { display: none; }
        .active-section { display: block; animation: fadeInRight 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); width: 250px; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 20px; }
            .mobile-btn { display: block !important; }
        }
        .mobile-btn {
            display: none; position: fixed; bottom: 20px; right: 20px;
            background: var(--primary); border: none; width: 60px; height: 60px;
            border-radius: 50%; z-index: 2000; box-shadow: var(--neon-glow);
        }
        @keyframes fadeInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-overlay">
    <div class="login-box animate__animated animate__zoomIn">
        <h2 class="text-primary mb-4" style="font-family: 'Orbitron'">SYSTEM LOCKED</h2>
        <div class="mb-3"><input type="email" id="adminEmail" class="form-control text-center" placeholder="Admin Email"></div>
        <div class="mb-4"><input type="password" id="adminPass" class="form-control text-center" placeholder="Access Code"></div>
        <button class="btn btn-neon w-100" onclick="handleLogin()">AUTHENTICATE</button>
        <p id="loginError" class="text-danger mt-3 small"></p>
    </div>
</div>

<!-- APP -->
<div class="app-interface">
    <button class="mobile-btn" onclick="document.getElementById('sidebar').classList.toggle('active')"><i class="fas fa-bars"></i></button>

    <div class="sidebar" id="sidebar">
        <h2>COINLY ADMIN</h2>
        <a class="nav-link active" onclick="showSection('home', this)"><i class="fas fa-chart-pie"></i> Dashboard</a>
        <a class="nav-link" onclick="showSection('promo', this)"><i class="fas fa-gift"></i> Promo Codes</a>
        <a class="nav-link" onclick="showSection('users', this)"><i class="fas fa-users"></i> User Manager</a>
        <a class="nav-link" onclick="showSection('withdraw', this)"><i class="fas fa-wallet"></i> Withdrawals</a>
        <a class="nav-link" onclick="showSection('task', this)"><i class="fas fa-tasks"></i> Ads/Tasks</a>
        <a class="nav-link text-danger mt-5" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <div class="main-content">
        
        <!-- DASHBOARD -->
        <div id="home" class="section active-section">
            <h2 class="mb-4">Live Analytics</h2>
            <div class="row g-4">
                <div class="col-xl-3 col-md-6">
                    <div class="glass-card">
                        <p class="text-muted">Total Users</p>
                        <div class="stat-val" id="totalUsers">0</div>
                        <div class="progress" style="height: 5px; background: #1e293b;">
                            <div class="progress-bar bg-primary" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="glass-card">
                        <p class="text-muted" style="color: var(--purple) !important;">Joined Today</p>
                        <div class="stat-val" id="todayJoined" style="color: var(--purple);">0</div>
                        <small class="text-muted">New operatives in 24h</small>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="glass-card">
                        <p class="text-muted" style="color: var(--secondary) !important;">Pending Withdrawals</p>
                        <div class="stat-val" id="pendingWithdraw" style="color: var(--secondary);">0</div>
                        <small class="text-muted">Requests needing action</small>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="glass-card">
                        <p class="text-muted" style="color: #f1c40f !important;">Total GG Distributed</p>
                        <div class="stat-val" id="totalGG" style="color: #f1c40f;">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROMO CODES (NEW) -->
        <div id="promo" class="section">
            <h2 class="mb-4">Promo Code Generator</h2>
            <div class="row g-4">
                <div class="col-md-5">
                    <div class="glass-card">
                        <h4 class="text-primary mb-3"><i class="fas fa-plus-circle"></i> Create Code</h4>
                        <div class="input-group mb-3">
                            <input type="text" id="promoCode" class="form-control" placeholder="6 Digit Code" maxlength="6">
                            <button class="btn btn-secondary" onclick="generateRandomCode()">Random</button>
                        </div>
                        
                        <div class="mb-3">
                            <label class="text-muted">Reward Type</label>
                            <select id="rewardType" class="form-select">
                                <option value="gg">GG Points</option>
                                <option value="hash">Hash Power (24h)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="text-muted">Reward Amount</label>
                            <input type="number" id="rewardAmount" class="form-control" placeholder="e.g. 50 GG or 5 Hash">
                        </div>

                        <div class="mb-3">
                            <label class="text-muted">Max Users Limit</label>
                            <input type="number" id="maxUsers" class="form-control" placeholder="How many users can claim?">
                        </div>

                        <button class="btn btn-neon w-100" onclick="createPromoCode()">DEPLOY CODE</button>
                    </div>
                </div>

                <div class="col-md-7">
                    <div class="glass-card">
                        <h4 class="text-secondary mb-3"><i class="fas fa-list"></i> Active Codes</h4>
                        <div class="table-responsive">
                            <table class="custom-table">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Reward</th>
                                        <th>Usage</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="promoList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- USER MANAGER -->
        <div id="users" class="section">
            <h2 class="mb-4">User Management</h2>
            <div class="glass-card mb-4">
                <div class="row g-3">
                    <div class="col-md-8">
                        <input type="text" id="userSearch" class="form-control" placeholder="Search by Username (without @) or User ID...">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-neon w-100" onclick="searchUser()"><i class="fas fa-search"></i> SEARCH</button>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="table-responsive">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>User Info</th>
                                <th>Stats</th>
                                <th>Refers</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="userList"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- WITHDRAWALS -->
        <div id="withdraw" class="section">
            <h2 class="mb-4">Withdraw Requests</h2>
            <div class="glass-card">
                <div class="table-responsive">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Method / Addr</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawList"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TASKS -->
        <div id="task" class="section">
            <h2 class="mb-4">Ads & Tasks</h2>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="glass-card">
                        <h4 class="text-primary">Add Task</h4>
                        <input type="text" id="taskTitle" class="form-control mb-2" placeholder="Title">
                        <input type="text" id="taskLink" class="form-control mb-2" placeholder="Link">
                        <input type="number" id="taskReward" class="form-control mb-3" placeholder="Reward GG">
                        <button class="btn btn-neon w-100" onclick="deployTask()">Add Task</button>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="glass-card">
                        <table class="custom-table">
                            <thead><tr><th>Title</th><th>Reward</th><th>Action</th></tr></thead>
                            <tbody id="activeTaskList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, limit, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

    // REPLACE WITH YOUR FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyAUQBTiqBfPwM5idPo9GKwuggvyRFKSopE",
        authDomain: "coinly-tix-ton-fd0c3.firebaseapp.com",
        projectId: "coinly-tix-ton-fd0c3",
        storageBucket: "coinly-tix-ton-fd0c3.firebasestorage.app",
        messagingSenderId: "204024049838",
        appId: "1:204024049838:web:b64e08efe08526b0c33d3f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- AUTH ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('login-overlay').style.display = 'none';
            document.querySelector('.app-interface').style.display = 'block';
            startApp();
        } else {
            document.getElementById('login-overlay').style.display = 'flex';
        }
    });

    window.handleLogin = async () => {
        const email = document.getElementById('adminEmail').value;
        const pass = document.getElementById('adminPass').value;
        try {
            await signInWithEmailAndPassword(auth, email, pass);
        } catch (error) { document.getElementById('loginError').innerText = error.message; }
    };

    window.handleLogout = () => signOut(auth);

    function startApp() {
        loadDashboard();
        loadPromoCodes();
        loadUsers(); // Initial load of top 20
        loadWithdrawals();
        loadTasks();
    }

    // --- 1. DASHBOARD LOGIC ---
    function loadDashboard() {
        // Users Listener
        onSnapshot(collection(db, "users"), (snap) => {
            let total = snap.size;
            let today = 0;
            let totalGG = 0;
            const dateStr = new Date().toISOString().split('T')[0];

            snap.forEach(d => {
                const u = d.data();
                // Check if joined today
                // Note: Assuming you save 'lastAdDate' or 'joinedAt'. 
                // Using lastAdDate as approximation if joinedAt missing, or check timestamp
                if(u.joinedAt && u.joinedAt.toDate().toISOString().split('T')[0] === dateStr) {
                    today++;
                } else if(!u.joinedAt && u.lastAdDate === dateStr) {
                     // Fallback logic
                }
                totalGG += (u.balanceGG || 0);
            });

            document.getElementById('totalUsers').innerText = total;
            document.getElementById('todayJoined').innerText = today; // Needs 'joinedAt' field in user doc
            document.getElementById('totalGG').innerText = Math.floor(totalGG);
        });

        // Pending Withdrawals Listener
        onSnapshot(query(collection(db, "withdrawals"), where("status", "==", "pending")), (snap) => {
            document.getElementById('pendingWithdraw').innerText = snap.size;
        });
    }

    // --- 2. PROMO CODE LOGIC (NEW) ---
    window.generateRandomCode = () => {
        const code = Math.floor(100000 + Math.random() * 900000);
        document.getElementById('promoCode').value = code;
    };

    window.createPromoCode = async () => {
        const code = document.getElementById('promoCode').value;
        const type = document.getElementById('rewardType').value;
        const amount = Number(document.getElementById('rewardAmount').value);
        const max = Number(document.getElementById('maxUsers').value);

        if(!code || !amount || !max) return alert("Fill all fields");

        const data = {
            active: true,
            maxUsers: max,
            currentUsers: 0,
            createdAt: serverTimestamp()
        };

        if(type === 'gg') data.rewardGG = amount;
        else data.rewardHash = amount;

        try {
            await setDoc(doc(db, "promoCodes", code), data);
            alert("Promo Code Deployed!");
            document.getElementById('promoCode').value = '';
        } catch(e) { alert("Error: " + e.message); }
    };

    function loadPromoCodes() {
        onSnapshot(collection(db, "promoCodes"), (snap) => {
            const list = document.getElementById('promoList');
            list.innerHTML = "";
            snap.forEach(d => {
                const p = d.data();
                const rewardTxt = p.rewardGG ? `${p.rewardGG} GG` : `${p.rewardHash} Hash`;
                list.innerHTML += `
                    <tr>
                        <td class="text-primary fw-bold" style="font-family:'Orbitron'">${d.id}</td>
                        <td>${rewardTxt}</td>
                        <td>${p.currentUsers} / ${p.maxUsers}</td>
                        <td><button class="btn btn-sm btn-outline-danger" onclick="deletePromo('${d.id}')"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            });
        });
    }

    window.deletePromo = async (id) => {
        if(confirm("Delete this code?")) await deleteDoc(doc(db, "promoCodes", id));
    };

    // --- 3. USER MANAGEMENT ---
    function loadUsers(searchTerm = "") {
        let q;
        if(searchTerm) {
            // Firestore simple search (exact match for ID or logic for username)
            // Note: Partial search is hard in Firestore without external tools. 
            // We will try direct ID fetch or Username exact match query
             const list = document.getElementById('userList');
             list.innerHTML = "Searching...";
             
             // Try fetching by ID first
             getDoc(doc(db, "users", searchTerm)).then(docSnap => {
                 if(docSnap.exists()) renderUserRow(docSnap, list, true);
                 else {
                     // Try by username
                     const qUser = query(collection(db, "users"), where("username", "==", searchTerm));
                     getDocs(qUser).then(snap => {
                         list.innerHTML = "";
                         if(snap.empty) list.innerHTML = "<tr><td colspan='5'>No user found.</td></tr>";
                         snap.forEach(d => renderUserRow(d, list, false));
                     });
                 }
             });
             return;
        }

        // Default Load (Top 20 by balance)
        q = query(collection(db, "users"), orderBy("balanceGG", "desc"), limit(20));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('userList');
            list.innerHTML = "";
            snap.forEach(d => renderUserRow(d, list, false));
        });
    }

    function renderUserRow(d, list, clear) {
        if(clear) list.innerHTML = "";
        const u = d.data();
        const row = `
            <tr>
                <td>
                    <div class="fw-bold text-white">${u.firstName || 'User'}</div>
                    <small class="text-muted">@${u.username} | UID: ${d.id}</small>
                </td>
                <td>
                    <div class="text-warning">${Math.floor(u.balanceGG || 0)} GG</div>
                    <div class="text-info small">${u.gameTokens || 0} Tokens</div>
                </td>
                <td>${u.referrals || 0}</td>
                <td><span class="badge ${u.isBanned ? 'bg-danger':'bg-success'}">${u.isBanned?'Banned':'Active'}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="toggleBan('${d.id}', ${u.isBanned})">
                        ${u.isBanned ? 'Unban' : 'Ban'}
                    </button>
                </td>
            </tr>
        `;
        list.innerHTML += row;
    }

    window.searchUser = () => {
        const val = document.getElementById('userSearch').value.trim();
        loadUsers(val);
    };

    window.toggleBan = async (uid, status) => {
        await updateDoc(doc(db, "users", uid), { isBanned: !status });
    };

    // --- 4. WITHDRAWALS ---
    function loadWithdrawals() {
        onSnapshot(query(collection(db, "withdrawals"), orderBy("date", "desc"), limit(50)), (snap) => {
            const list = document.getElementById('withdrawList');
            list.innerHTML = "";
            snap.forEach(d => {
                const w = d.data();
                const btn = w.status === 'pending' 
                    ? `<button class="btn btn-sm btn-neon" onclick="payWithdraw('${d.id}')">PAY</button>`
                    : `<span class="text-success">PAID</span>`;
                
                list.innerHTML += `
                    <tr>
                        <td>UID: ${w.userId}</td>
                        <td>
                            <div>${w.method.toUpperCase()}</div>
                            <small class="text-muted" onclick="navigator.clipboard.writeText('${w.address}')" style="cursor:pointer">${w.address} <i class="fas fa-copy"></i></small>
                        </td>
                        <td class="text-white fw-bold">${w.amount} GG</td>
                        <td><span class="badge ${w.status==='pending'?'bg-warning':'bg-success'}">${w.status}</span></td>
                        <td>${btn}</td>
                    </tr>
                `;
            });
        });
    }

    window.payWithdraw = async (id) => {
        if(confirm("Mark as PAID?")) await updateDoc(doc(db, "withdrawals", id), { status: 'paid' });
    };

    // --- 5. TASKS ---
    function loadTasks() {
        onSnapshot(collection(db, "adminTasks"), (snap) => {
            const list = document.getElementById('activeTaskList');
            list.innerHTML = "";
            snap.forEach(d => {
                const t = d.data();
                list.innerHTML += `
                    <tr>
                        <td>${t.title}</td>
                        <td class="text-warning">${t.reward} GG</td>
                        <td><button class="btn btn-sm btn-danger" onclick="delTask('${d.id}')">X</button></td>
                    </tr>
                `;
            });
        });
    }

    window.deployTask = async () => {
        const title = document.getElementById('taskTitle').value;
        const link = document.getElementById('taskLink').value;
        const reward = Number(document.getElementById('taskReward').value);
        if(!title) return;
        await setDoc(doc(collection(db, "adminTasks")), { title, link, reward });
        document.getElementById('taskTitle').value = "";
    };

    window.delTask = async (id) => deleteDoc(doc(db, "adminTasks", id));

    // Helpers
    window.showSection = (id, btn) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active-section'));
        document.getElementById(id).classList.add('active-section');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        btn.classList.add('active');
    };
</script>

</body>
</html>