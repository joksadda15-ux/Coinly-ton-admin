<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coinly Super Admin</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --primary: #0088cc;
            --accent: #f1c40f;
            --danger: #ef4444;
            --success: #22c55e;
            --border: #334155;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        /* Auth Overlay */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex;
            align-items: center; justify-content: center;
        }
        .auth-box {
            background: var(--card); padding: 40px; border-radius: 15px;
            border: 1px solid var(--primary); text-align: center; width: 300px;
        }
        input, select {
            width: 100%; padding: 12px; margin: 8px 0; background: #0f172a;
            border: 1px solid var(--border); color: white; border-radius: 8px; outline: none;
        }
        button {
            width: 100%; padding: 12px; margin-top: 10px; cursor: pointer;
            border: none; border-radius: 8px; font-weight: bold; transition: 0.3s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #026aa7; }
        .btn-danger { background: var(--danger); color: white; }

        /* Admin Dashboard */
        #admin-panel { display: none; max-width: 1200px; margin: 0 auto; }
        
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px;
        }
        .nav-menu { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .nav-btn {
            background: var(--card); color: #aaa; padding: 10px 20px; width: auto;
            border: 1px solid var(--border);
        }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Cards */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .card {
            background: var(--card); border: 1px solid var(--border);
            padding: 15px; border-radius: 10px; position: relative;
        }
        .stat-card { text-align: center; padding: 20px; }
        .stat-num { font-size: 2em; font-family: 'Rajdhani', sans-serif; font-weight: bold; color: var(--accent); }

        /* Tables & Lists */
        .data-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9em;
        }
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        .tag-pend { background: var(--accent); color: black; }
        .tag-paid { background: var(--success); color: black; }

        .loader {
            border: 3px solid #333; border-top: 3px solid var(--primary);
            border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="auth-screen">
        <div class="auth-box">
            <h2 style="color:var(--primary); margin-bottom:20px;">SUPER ADMIN</h2>
            <input type="email" id="a-email" placeholder="Email">
            <input type="password" id="a-pass" placeholder="Password">
            <button class="btn-primary" onclick="adminLogin()">LOGIN</button>
            <p id="login-msg" style="color:red; font-size:0.8em; margin-top:10px;"></p>
        </div>
    </div>

    <!-- PANEL -->
    <div id="admin-panel">
        <div class="header">
            <h2><i class="fas fa-shield-alt"></i> Control Panel</h2>
            <button class="btn-danger" style="width:auto; padding:8px 20px;" onclick="adminLogout()">LOGOUT</button>
        </div>

        <div class="nav-menu">
            <button class="nav-btn active" onclick="switchTab('dash')">Dashboard</button>
            <button class="nav-btn" onclick="switchTab('users')">Users</button>
            <button class="nav-btn" onclick="switchTab('tasks')">Tasks (Add/Manage)</button>
            <button class="nav-btn" onclick="switchTab('promo')">Promo Codes</button>
            <button class="nav-btn" onclick="switchTab('withdraw')">Withdrawals</button>
        </div>

        <!-- DASHBOARD -->
        <div id="tab-dash" class="section active">
            <div class="grid-container">
                <div class="card stat-card">
                    <h3>Total Users</h3>
                    <div class="stat-num" id="stat-users">...</div>
                </div>
                <div class="card stat-card">
                    <h3>Pending Withdrawals</h3>
                    <div class="stat-num" id="stat-wd">...</div>
                </div>
                <div class="card stat-card">
                    <h3>Active Promo Codes</h3>
                    <div class="stat-num" id="stat-promo">...</div>
                </div>
            </div>
        </div>

        <!-- TASKS MANAGEMENT -->
        <div id="tab-tasks" class="section">
            <div class="grid-container">
                <!-- Add Task -->
                <div class="card">
                    <h3 style="color:var(--accent);">Create New Task</h3>
                    <div style="margin-top:15px;">
                        <label>Task Title</label>
                        <input type="text" id="t-title" placeholder="e.g. Join Channel">
                        
                        <label>Task Link</label>
                        <input type="text" id="t-link" placeholder="https://t.me/...">
                        
                        <label>Reward (GG)</label>
                        <input type="number" id="t-reward" placeholder="e.g. 100">
                        
                        <button class="btn-primary" onclick="createTask()">ADD TASK</button>
                    </div>
                </div>

                <!-- Task List -->
                <div class="card" style="grid-column: span 2;">
                    <h3>Active Tasks List</h3>
                    <div id="task-list-container" style="margin-top:15px;">
                        Loading...
                    </div>
                </div>
            </div>
        </div>

        <!-- PROMO CODES -->
        <div id="tab-promo" class="section">
            <div class="grid-container">
                <!-- Generate -->
                <div class="card">
                    <h3 style="color:#ff00cc;">Generate Promo Code</h3>
                    <div style="margin-top:15px;">
                        <label>Reward Type</label>
                        <select id="p-type">
                            <option value="gg">GG Points (Balance)</option>
                            <option value="hash">Mining Boosts (Hash)</option>
                        </select>
                        
                        <label>Amount</label>
                        <input type="number" id="p-amount" placeholder="e.g. 100 or 5">
                        
                        <label>Max Users</label>
                        <input type="number" id="p-max" value="100">
                        
                        <button class="btn-primary" style="background: linear-gradient(45deg, #ff00cc, #333399);" onclick="createPromo()">GENERATE CODE</button>
                    </div>
                </div>

                <!-- List -->
                <div class="card" style="grid-column: span 2;">
                    <h3>Active Codes</h3>
                    <div id="promo-list-container">Loading...</div>
                </div>
            </div>
        </div>

        <!-- USERS -->
        <div id="tab-users" class="section">
            <div style="margin-bottom:15px; display:flex; gap:10px;">
                <input type="text" id="u-search" placeholder="Search User ID..." style="max-width:300px;">
                <button class="btn-primary" style="width:auto;" onclick="searchUser()">Search</button>
            </div>
            <div id="users-list-container" class="grid-container"></div>
        </div>

        <!-- WITHDRAWALS -->
        <div id="tab-withdraw" class="section">
            <button class="btn-primary" style="width:auto; margin-bottom:10px;" onclick="loadWithdrawals()">Refresh List</button>
            <div id="wd-list-container" class="grid-container"></div>
        </div>

    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy, increment, getCountFromServer, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAUQBTiqBfPwM5idPo9GKwuggvyRFKSopE",
            authDomain: "coinly-tix-ton-fd0c3.firebaseapp.com",
            projectId: "coinly-tix-ton-fd0c3",
            storageBucket: "coinly-tix-ton-fd0c3.firebasestorage.app",
            messagingSenderId: "204024049838",
            appId: "1:204024049838:web:b64e08efe08526b0c33d3f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTH SYSTEM ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                loadStats();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('admin-panel').style.display = 'none';
            }
        });

        window.adminLogin = () => {
            const e = document.getElementById('a-email').value;
            const p = document.getElementById('a-pass').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => document.getElementById('login-msg').innerText = err.message);
        };

        window.adminLogout = () => signOut(auth);

        // --- NAVIGATION ---
        window.switchTab = (tabId) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById('tab-'+tabId).classList.add('active');
            event.target.classList.add('active');

            if(tabId === 'tasks') loadTasks();
            if(tabId === 'promo') loadPromos();
            if(tabId === 'withdraw') loadWithdrawals();
        };

        // --- 1. TASKS LOGIC ---
        window.createTask = async () => {
            const title = document.getElementById('t-title').value;
            const link = document.getElementById('t-link').value;
            const reward = parseInt(document.getElementById('t-reward').value);

            if(!title || !link || !reward) return alert("Fill all fields!");

            try {
                // Apps "adminTasks" collection e data add hobe
                await addDoc(collection(db, "adminTasks"), {
                    title: title,
                    link: link,
                    reward: reward
                });
                alert("Task Created Successfully!");
                document.getElementById('t-title').value = "";
                document.getElementById('t-link').value = "";
                document.getElementById('t-reward').value = "";
                loadTasks();
            } catch(e) { alert("Error: " + e.message); }
        };

        window.loadTasks = async () => {
            const div = document.getElementById('task-list-container');
            div.innerHTML = '<div class="loader"></div>';
            
            try {
                const snap = await getDocs(collection(db, "adminTasks"));
                div.innerHTML = '';
                if(snap.empty) { div.innerHTML = 'No tasks found.'; return; }

                snap.forEach(d => {
                    const t = d.data();
                    div.innerHTML += `
                    <div class="data-row" style="background:#0f172a; margin-bottom:5px; border-radius:5px;">
                        <div>
                            <b>${t.title}</b><br>
                            <span style="color:var(--primary); font-size:0.8em;">${t.reward} GG</span> | 
                            <a href="${t.link}" target="_blank" style="color:#aaa;">Link</a>
                        </div>
                        <button class="btn-danger" style="width:auto; padding:5px 10px;" onclick="deleteItem('adminTasks', '${d.id}', 'task')">Delete</button>
                    </div>`;
                });
            } catch(e) { div.innerHTML = "Error loading tasks."; }
        };

        // --- 2. PROMO CODE LOGIC ---
        window.createPromo = async () => {
            const type = document.getElementById('p-type').value;
            const amount = parseInt(document.getElementById('p-amount').value);
            const max = parseInt(document.getElementById('p-max').value);

            if(!amount || !max) return alert("Invalid Input");

            // 6 digit code generation
            const code = Math.floor(100000 + Math.random() * 900000).toString();

            const data = {
                active: true,
                maxUsers: max,
                currentUsers: 0,
                createdAt: serverTimestamp()
            };

            // App er logic onujayi field set kora hocche
            if(type === 'gg') data.rewardGG = amount;
            else data.rewardHash = amount;

            try {
                await setDoc(doc(db, "promoCodes", code), data);
                alert(`Code Generated: ${code}`);
                loadPromos();
            } catch(e) { alert("Error: " + e.message); }
        };

        window.loadPromos = async () => {
            const div = document.getElementById('promo-list-container');
            div.innerHTML = '<div class="loader"></div>';
            
            try {
                const q = query(collection(db, "promoCodes"), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);
                div.innerHTML = '';
                
                snap.forEach(d => {
                    const p = d.data();
                    const rewardTxt = p.rewardGG ? `${p.rewardGG} GG` : `${p.rewardHash} Hash`;
                    div.innerHTML += `
                    <div class="data-row" style="background:#0f172a; margin-bottom:5px; border-radius:5px;">
                        <div>
                            <span style="color:#ff00cc; font-weight:bold; font-size:1.2em;">${d.id}</span>
                            <div style="font-size:0.8em; color:#aaa;">${rewardTxt} | Used: ${p.currentUsers}/${p.maxUsers}</div>
                        </div>
                        <button class="btn-danger" style="width:auto; padding:5px 10px;" onclick="deleteItem('promoCodes', '${d.id}', 'promo')">Delete</button>
                    </div>`;
                });
            } catch(e) { div.innerHTML = "Error loading promos."; }
        };

        // --- 3. WITHDRAWALS ---
        window.loadWithdrawals = async () => {
            const div = document.getElementById('wd-list-container');
            div.innerHTML = '<div class="loader"></div>';
            try {
                const q = query(collection(db, "withdrawals"), where("status", "==", "pending"));
                const snap = await getDocs(q);
                div.innerHTML = '';
                if(snap.empty) { div.innerHTML = "No pending withdrawals."; return; }

                snap.forEach(d => {
                    const w = d.data();
                    div.innerHTML += `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between;">
                            <b>User ID: ${w.userId}</b>
                            <span class="tag tag-pend">PENDING</span>
                        </div>
                        <div style="margin:10px 0;">
                            <div style="font-size:1.2em; color:var(--success); font-weight:bold;">${w.amount} GG</div>
                            <div style="font-size:0.9em; color:#ccc;">${w.method} | ${w.address}</div>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-primary" style="background:var(--success);" onclick="processWd('${d.id}', true)">PAID</button>
                            <button class="btn-danger" onclick="processWd('${d.id}', false, '${w.userId}', ${w.amount})">REFUND</button>
                        </div>
                    </div>`;
                });
            } catch(e) { console.log(e); }
        };

        window.processWd = async (id, isPaid, uid, amount) => {
            if(!confirm(isPaid ? "Mark as PAID?" : "Reject and Refund?")) return;
            try {
                const ref = doc(db, "withdrawals", id);
                if(isPaid) {
                    await updateDoc(ref, { status: "paid" });
                } else {
                    await updateDoc(ref, { status: "rejected" });
                    await updateDoc(doc(db, "users", uid), { balanceGG: increment(amount) });
                }
                loadWithdrawals();
                loadStats();
            } catch(e) { alert("Error"); }
        };

        // --- 4. USERS ---
        window.searchUser = async () => {
            const uid = document.getElementById('u-search').value.trim();
            const div = document.getElementById('users-list-container');
            if(!uid) return;
            div.innerHTML = '<div class="loader"></div>';

            try {
                const snap = await getDocs(query(collection(db, "users"), where("userId", "==", uid)));
                div.innerHTML = '';
                if(snap.empty) { div.innerHTML = "User not found."; return; }

                snap.forEach(d => {
                    const u = d.data();
                    div.innerHTML += `
                    <div class="card">
                        <h3>${u.firstName} (@${u.username})</h3>
                        <p style="font-size:0.8em; color:#aaa;">ID: ${u.userId}</p>
                        <div style="margin:10px 0; background:#0f172a; padding:10px; border-radius:5px;">
                            <div>Balance: <b style="color:var(--accent);">${Math.floor(u.balanceGG)} GG</b></div>
                            <div>Tokens: <b style="color:#9b59b6;">${u.gameTokens} GAME</b></div>
                            <div>Refs: <b>${u.referrals}</b></div>
                            <div>Banned: <b style="color:${u.isBanned?'red':'green'}">${u.isBanned||'false'}</b></div>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-primary" onclick="editUser('${d.id}', 'gg')">Edit GG</button>
                            <button class="btn-primary" style="background:#9b59b6;" onclick="editUser('${d.id}', 'token')">Edit Token</button>
                            <button class="btn-danger" onclick="toggleBan('${d.id}', ${u.isBanned})">${u.isBanned?'Unban':'Ban'}</button>
                        </div>
                    </div>`;
                });
            } catch(e) { div.innerHTML = "Error finding user."; }
        };

        window.editUser = async (uid, type) => {
            const val = prompt(`Add amount to ${type} (use negative to deduct):`);
            if(!val) return;
            const amount = parseFloat(val);
            if(isNaN(amount)) return;

            const update = {};
            if(type === 'gg') update.balanceGG = increment(amount);
            if(type === 'token') update.gameTokens = increment(amount);

            await updateDoc(doc(db, "users", uid), update);
            alert("Updated!");
            searchUser(); // refresh
        };

        window.toggleBan = async (uid, currentStatus) => {
            if(confirm(currentStatus ? "Unban User?" : "Ban User?")) {
                await updateDoc(doc(db, "users", uid), { isBanned: !currentStatus });
                searchUser();
            }
        };

        // --- UTILS ---
        window.deleteItem = async (col, id, type) => {
            if(confirm("Delete this?")) {
                await deleteDoc(doc(db, col, id));
                if(type === 'task') loadTasks();
                if(type === 'promo') loadPromos();
            }
        };

        async function loadStats() {
            try {
                const u = await getCountFromServer(collection(db, "users"));
                document.getElementById('stat-users').innerText = u.data().count;
                
                const w = await getCountFromServer(query(collection(db, "withdrawals"), where("status","==","pending")));
                document.getElementById('stat-wd').innerText = w.data().count;
            } catch(e) {}
        }
    </script>
</body>
</html>